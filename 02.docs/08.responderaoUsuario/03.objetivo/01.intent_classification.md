# 01. Classificação de Intenção

## Objetivo

O primeiro passo no fluxo de conversação é determinar a **intenção** do usuário a partir de sua mensagem de texto. Esta classificação é crucial para direcionar a lógica subsequente do sistema.

## Ferramentas

- **Modelo:** `ChatGemini`
- **Prompt:** `ChatPromptTemplate` do LangChain

## Prompt de Classificação

O prompt a seguir é enviado ao Gemini. Ele contém a mensagem do usuário, o número de telefone e um conjunto de instruções claras para que o modelo retorne um objeto JSON estruturado com a intenção e, se aplicável, uma consulta SQL ou uma resposta direta.

```text
Você é um assistente de sistema de reservas. Com base na mensagem do usuário, classifique a intenção e gere uma resposta ou consulta SQL conforme necessário.

Mensagem do Usuário: {user_message}
Número de Telefone do Usuário: {phone_number}

Intenções possíveis:
1. check_user: Verificar se o usuário está registrado.
2. check_availability: Verificar disponibilidade de quiosques ou quadras de beach tennis.
3. make_reservation: Criar uma reserva para um quiosque ou quadra.
4. cancel_reservation: Cancelar uma reserva existente.
5. check_reservations: Visualizar as reservas ativas do usuário.
6. join_waitlist: Entrar na lista de espera para um recurso.
7. general_query: Lidar com perguntas gerais ou intenções desconhecidas.

Instruções:
- Para check_user, gere uma consulta SQL para verificar se o phone_number existe em cadastro_pessoas_fisica.
- Para check_availability, gere uma consulta SQL para encontrar quiosques ou quadras disponíveis para uma data/hora específica.
- Para make_reservation, gere uma consulta SQL para criar uma reserva provisória.
- Para cancel_reservation, gere uma consulta SQL para cancelar uma reserva e verificar a lista de espera.
- Para check_reservations, gere uma consulta SQL para listar as reservas ativas do usuário.
- Para join_waitlist, gere uma consulta SQL para adicionar o usuário à lista de espera.
- Para general_query, forneça uma resposta em linguagem natural ou peça esclarecimentos.

Retorne um objeto JSON com:
- intent: A intenção classificada
- sql_query: A consulta SQL (se aplicável)
- response: A resposta para o usuário (se nenhuma consulta SQL for necessária)

Exemplo:
{
  "intent": "check_user",
  "sql_query": "SELECT * FROM cadastro_pessoas_fisica WHERE phone_number = '123456789'",
  "response": null
}
```

## Lógica de Pós-processamento

O resultado do modelo Gemini é um JSON (em formato de string). A aplicação faz o parse desse JSON para extrair os campos `intent`, `sql_query` e `response`, que serão usados nas etapas seguintes do grafo LangGraph. Em caso de falha no parse, a intenção é definida como `general_query` e uma resposta padrão é enviada.

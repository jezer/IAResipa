# 07. Checklist de Atividades: Testes de Código Python

Este checklist detalha as atividades necessárias para testar o código Python do projeto, seguindo as convenções estabelecidas em [01.1. Convenções de Testes Python (Pytest)](../00.rules/02.coding/01.01.python_tests_conventions.md).

## 07.1. Preparação do Ambiente de Teste

- [x] **Instalar Pytest e pytest-cov:**
    ```bash
    pip install pytest pytest-cov
    ```

## 07.2. Escrita de Testes

- [x] **Identificar Módulos/Funções a Testar:** Para cada script ou módulo Python (`.py`) em `03.src/`, identifique as funções, classes e métodos que precisam de cobertura de teste.
- [x] **Criar Estrutura de Testes:**
    - Crie um diretório `tests/` na raiz do projeto, se ainda não existir.
    - Dentro de `tests/`, espelhe a estrutura de diretórios do `03.src/`. Por exemplo, se você tem `03.src/resipa_lib/py_01_pix_generator.py`, crie `tests/resipa_lib/test_py_01_pix_generator.py`.
- [x] **Escrever Casos de Teste:**
    - Para cada função ou método, escreva um ou mais casos de teste que cubram diferentes cenários (entradas válidas, entradas inválidas, casos de borda).
    - Utilize funções de teste (`test_nome_da_funcao()`) ou classes de teste (`class TestNomeDaClasse:`) conforme a complexidade e agrupamento.
    - Use asserções (`assert`) para verificar os resultados esperados.
    - Considere o uso de `fixtures` para setup e teardown de recursos (ex: conexão com banco de dados, objetos mock).

## 07.3. Execução de Testes

- [x] **Executar Todos os Testes:**
    ```bash
    pytest
    ```
- [x] **Executar Testes de um Módulo Específico:**
    ```bash
    pytest tests/resipa_lib/test_nome_do_modulo.py
    ```
- [ ] **Executar Testes com Cobertura de Código:**
    ```bash
    pytest --cov=src
    ```
    - Analise o relatório de cobertura para identificar áreas do código que precisam de mais testes.

## 07.4. Revisão e Manutenção

- [ ] **Revisar Testes:** Garanta que os testes são claros, concisos e fáceis de entender.
- [ ] **Manter Testes Atualizados:** Sempre que o código de produção for alterado, revise e atualize os testes correspondentes para garantir que continuem válidos e relevantes.
- [ ] **Integração Contínua (Opcional):** Se aplicável, configure a execução automática dos testes em um pipeline de CI/CD.

## 07.5. Testes de Integração com Supabase (Sem Mocks)

Esta seção descreve como executar testes que interagem diretamente com o serviço Supabase, sem o uso de mocks. Isso garante que a comunicação, autenticação e operações de CRUD (Create, Read, Update, Delete) funcionem corretamente com o ambiente real do Supabase.

### Pré-requisitos:

- **Tabelas Criadas:** As tabelas necessárias (`cadastro_pessoas_fisica`, `recursos`, `reservas`, `lista_espera`) devem existir no seu banco de dados Supabase. O script SQL para criação dessas tabelas está em `03.src/resipa/A_db/sql_scripts/create_tables.sql`.
- **Credenciais Configuradas:** As variáveis de ambiente `SUPABASE_URL` e `SUPABASE_KEY` devem estar configuradas. Para desenvolvimento local, elas são carregadas do arquivo `.env` na raiz do projeto.

### Execução dos Testes de Integração:

Os testes de integração para o Supabase estão localizados no arquivo `03.src/resipa/A_db/db_00_dpsk_supabase_teste.py`. Este script realiza testes de conexão, autenticação e operações CRUD básicas.

Para executar estes testes, utilize o seguinte comando no terminal:

```bash
python 03.src/resipa/A_db/db_00_dpsk_supabase_teste.py
```

Se você encontrar erros de codificação (relacionados a caracteres especiais ou emojis) na saída do console, tente executar com a variável de ambiente `PYTHONIOENCODING` definida para `utf-8`:

```bash
set PYTHONIOENCODING=utf-8 & python 03.src/resipa/A_db/db_00_dpsk_supabase_teste.py
```

### Verificação dos Resultados:

- A saída do console indicará se os testes de conexão, autenticação e CRUD foram bem-sucedidos (`✅`) ou falharam (`❌`).
- Em caso de falha, verifique as mensagens de erro para diagnosticar o problema (ex: tabelas inexistentes, RLS, credenciais inválidas).

### Considerações Importantes:

- **Ambiente de Teste Dedicado:** É altamente recomendável usar um projeto Supabase ou um esquema dedicado para testes de integração para evitar a manipulação de dados de produção.
- **Row Level Security (RLS):** Para que as operações de CRUD funcionem, as políticas de RLS nas tabelas do Supabase devem permitir as ações de `INSERT`, `SELECT`, `UPDATE` e `DELETE` para o usuário autenticado (ou para usuários anônimos, dependendo da sua configuração de teste).
- **Limpeza de Dados:** Os testes de CRUD inserem e excluem dados. Certifique-se de que este comportamento é aceitável para o ambiente onde os testes estão sendo executados.


# Detalhes para Implementação do `py_waha_receiver.py`

Este documento detalha a implementação do **`py_waha_receiver.py`**, um novo arquivo a ser criado em `03.src/resipaia/`.

O `py_waha_receiver.py` atuará como o ponto de entrada para todas as interações do Waha, funcionando como um servidor de webhook. Ele será responsável por receber a carga de dados (payload), pré-processar (transcrever/OCR), encaminhar para o processador principal e retornar a resposta ao Waha.

## Atributos da Classe `WahaReceiver`

-   `waha_api_url`: A URL base da API do Waha, necessária para enviar respostas.
-   `host`: O endereço de host para o servidor web (ex: '0.0.0.0').
-   `port`: A porta para o servidor web (ex: 8080).

## Métodos da Classe `WahaReceiver`

### `__init__(self, waha_api_url, host, port)`

-   Inicializa a classe com os dados de configuração.

### `start_server(self)`

-   Inicia um servidor web (ex: usando FastAPI) para escutar requisições na rota `/webhook`.

### `handle_webhook(self, request)`

-   **Etapa 1:** Recebe a requisição, extrai o `chatId` e o corpo da mensagem. Retorna uma resposta simples e imediata: `{"status": "received"}`. A resposta ao usuário final será enviada de forma assíncrona.
-   **Etapa 2:** Em uma thread separada ou tarefa de fundo (background task), chama a função `process_message_from_waha` para lidar com a lógica de negócio.

### `process_message_from_waha(self, message_details)`

-   **Etapa 1 (Teste Simples):** Inicialmente, este método apenas chamará `send_response_to_waha` com uma mensagem fixa ("Obrigado, iremos analisar.").
-   **Etapa 2 (Integração):** Este método será modificado para:
    1.  **Pré-processar a mensagem:** Chamar `_transcribe_audio` ou `_ocr_image` se a mensagem for de áudio ou imagem, respectivamente, para obter o texto.
    2.  Formatar o `message_details` (agora com o texto extraído) para o padrão esperado pelo `py_main_processor.py`.
    3.  Invocar a função `process_message_logic` de `py_main_processor.py`.
    4.  Chamar `send_response_to_waha` com a resposta retornada pelo processador.

### `_transcribe_audio(self, audio_url) -> str`

-   **Novo Método:** Responsável por baixar o arquivo de áudio da `audio_url` fornecida pelo Waha e transcrevê-lo para texto. Pode utilizar bibliotecas de processamento de áudio e APIs de transcrição (ex: Google Speech-to-Text, Whisper).
-   **Considerações:** Lidar com diferentes formatos de áudio e possíveis erros de transcrição.

### `_ocr_image(self, image_url) -> str`

-   **Novo Método:** Responsável por baixar a imagem da `image_url` fornecida pelo Waha e extrair texto usando OCR. Pode utilizar bibliotecas como Tesseract ou APIs de OCR (ex: Google Cloud Vision).
-   **Considerações:** Lidar com diferentes formatos de imagem, qualidade da imagem e idiomas.

### `send_response_to_waha(self, chat_id, message)`

-   Envia a mensagem final para o `chat_id` especificado através de uma chamada à API do Waha (usando o `waha_api_url`).

## Considerações de Implementação

### Concorrência e Assincronia

A rota `/webhook` deve responder o mais rápido possível. A lógica de processamento, incluindo transcrição/OCR e a chamada para `py_main_processor.py`, deve ocorrer de forma assíncrona para não bloquear o recebimento de novas mensagens. Isso garante que o sistema possa lidar com múltiplas requisições concorrentes de diferentes `chatId`s de forma segura.

### Tratamento de Erros e Fallback

É crucial implementar um robusto tratamento de erros para as operações de transcrição e OCR. Em caso de falha, o sistema deve ter um mecanismo de fallback (ex: responder com uma mensagem de erro genérica ou tentar novamente).

## Estrutura do JSON do Waha (Exemplo)

É crucial analisar a documentação do Waha para entender a estrutura exata do JSON para cada tipo de mensagem (texto, áudio, imagem).

**Exemplo (mensagem de texto):**

```json
{
  "event": "message",
  "chatId": "5511999999999@c.us",
  "body": "Olá, mundo!",
  "fromMe": false,
  ...
}
```

**Exemplo (mensagem de áudio - hipotético):**

```json
{
  "event": "message",
  "chatId": "5511999999999@c.us",
  "type": "audio",
  "mediaUrl": "http://localhost:3000/media/audio_123.ogg",
  ...
}
```

**Exemplo (mensagem de imagem - hipotético):**

```json
{
  "event": "message",
  "chatId": "5511999999999@c.us",
  "type": "image",
  "mediaUrl": "http://localhost:3000/media/image_456.jpg",
  ...
}


# Detalhes para Implementação dos Testes de Concorrência

## Ferramentas Sugeridas

-   **Framework de Teste:** `pytest`
-   **Requisições HTTP:** `requests`
-   **Threading/Async:** `threading` ou `asyncio`
-   **Servidor Mock:** `Flask` ou `FastAPI` para criar o mock da API do Waha.

## Estrutura do Teste

1.  **`mock_waha_api.py`**
    *   Um servidor simples (Flask/FastAPI) com uma rota `/sendText`.
    *   A rota deve aceitar um POST com um JSON contendo `chatId` e `text`.
    *   Deve armazenar cada requisição recebida em uma lista ou dicionário global (cuidado com race conditions ao escrever, use um `Lock`).
    *   Deve ter uma rota `/results` para expor os dados armazenados para verificação.

2.  **`test_concurrency.py`**
    *   **Setup (`pytest.fixture`):**
        *   Inicia a aplicação `WahaReceiver` em uma thread separada.
        *   Inicia o `mock_waha_api` em outra thread.
        *   Garante que ambos estejam prontos para receber requisições antes de prosseguir.
    *   **Função de Teste (`test_handle_concurrent_messages`):**
        *   Define uma lista de `chatId`s únicos (ex: `['user1', 'user2', 'user3', 'user4', 'user5']`).
        *   Cria uma função `worker` que pega um `chatId`, cria um corpo de mensagem JSON e envia para o `/webhook` da aplicação.
        *   Usa um loop e o módulo `threading` para iniciar um `worker` para cada `chatId` da lista, quase simultaneamente.
        *   Aguarda a conclusão de todas as threads.
    *   **Verificação:**
        *   Faz uma requisição GET para a rota `/results` do `mock_waha_api`.
        *   Verifica se o número de resultados é igual ao número de `chatId`s enviados.
        *   Verifica se o conjunto de `chatId`s nos resultados é o mesmo que o conjunto de `chatId`s original.
        *   Verifica se o texto de cada resposta é o esperado.

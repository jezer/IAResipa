## Atividades para Melhorar a Coerência do Gemini

Para garantir que o Gemini responda de forma coerente e alinhada aos objetivos do sistema de reservas, mantendo o foco em todas as mensagens do usuário, as seguintes atividades são necessárias:

### 1. Revisão e Refinamento do Contexto do Gemini

**Atividade 1.1: Aprimorar o `contexto` na chamada da API Gemini com base em um resumo JSON abrangente.**

*   **Descrição:** O `contexto` passado para a função `gerar_resposta_gemini` deve ser mais detalhado e explícito sobre o papel do assistente e os tipos de interações que ele pode gerenciar. Para isso, utilizaremos um resumo abrangente dos objetivos e fluxos do projeto, consolidado em `C:\source\IAResipa\02.docs\06.interpretartexto\03.objetivo\dados\objectives_summary.json`. Isso ajuda o Gemini a focar nas respostas relevantes ao domínio de reservas.
*   **Local de Alteração:** Função `handle_gemini_query` em `C:\source\IAResipa\03.src\resipaia\interpretartexto\py_main_processor_v2.py`.
*   **Correção Sugerida:**
    1.  **Carregar o resumo JSON:** No início do arquivo `py_main_processor_v2.py`, carregar o conteúdo de `C:\source\IAResipa\02.docs\06.interpretartexto\03.objetivo\dados\objectives_summary.json`.
    2.  **Construir o contexto dinamicamente:** Utilizar as informações carregadas do JSON para construir um `contexto` mais rico e detalhado para o Gemini. Incluir a `system_overview`, `main_functionalities`, `gemini_role` e um resumo dos `detailed_flows_summary` do JSON. O contexto deve ser conciso, mas informativo, para guiar o Gemini.
    ```python
    # Exemplo de como o contexto pode ser construído
    # import json
    # import os
    # current_dir = os.path.dirname(os.path.abspath(__file__))
    # objectives_summary_path = os.path.join(current_dir, "..", "..", "02.docs", "06.interpretartexto", "03.objetivo", "dados", "objectives_summary.json")
    # with open(objectives_summary_path, 'r', encoding='utf-8') as f:
    #     objectives_summary = json.load(f)
    #
    # context_gemini = (
    #     f"Você é um assistente virtual especializado em {objectives_summary['system_overview']}. "
    #     f"Seu papel principal é: {objectives_summary['gemini_role']}. "
    #     f"As funcionalidades que você pode auxiliar são: {', '.join(objectives_summary['main_functionalities'])}. "
    #     f"Os fluxos detalhados incluem: {', '.join([f'{k}: {v}' for k, v in objectives_summary['detailed_flows_summary'].items()])}. "
    #     f"Responda de forma amigável, formal, útil e sempre focada nestes objetivos. "
    #     f"Se a pergunta do usuário estiver fora desses tópicos, direcione-o gentilmente para os serviços que você oferece."
    # )
    #
    # gemini_response = gerar_resposta_gemini(
    #     contexto=context_gemini,
    #     mensagem_usuario=full_prompt
    # )
    ```

### 2. Tratamento de Mensagens Iniciais e Intenções Genéricas

**Atividade 2.1: Implementar uma lógica de boas-vindas mais robusta para novos usuários ou mensagens genéricas.**

*   **Descrição:** Quando um usuário envia uma mensagem inicial como "Olá" ou "Eu posso fazer reserva?", o sistema deve fornecer uma introdução clara sobre seus serviços e como o usuário pode interagir. Isso pode ser feito com uma resposta pré-definida ou um prompt específico para o Gemini.
*   **Local de Alteração:** Função `process_message_logic` em `C:\source\IAResipa\03.src\resipaia\interpretartexto\py_main_processor_v2.py`.
*   **Correção Sugerida:**
    ```python
    # Dentro de process_message_logic, antes do roteamento para handle_gemini_query
    if message_text_lower in ["olá", "oi", "começar", "eu posso fazer reserva?"]:
        # Pode-se usar uma raw_message específica para o Gemini formatar a saudação
        response = {"to": from_number, "status": "info", "raw_message": "Olá! Bem-vindo(a) ao nosso sistema de reservas. Posso te ajudar a verificar a disponibilidade de recursos, criar, modificar ou cancelar reservas, e gerenciar pagamentos Pix. Como posso te auxiliar hoje?"}
    # ... (restante da lógica de roteamento)
    ```
    *   **Justificativa:** Isso garante que a primeira interação seja sempre informativa e direcione o usuário, mesmo que a pergunta seja genérica. O Gemini então formatará essa `raw_message` de forma amigável.

### 3. Gerenciamento de Múltiplas Instâncias de Usuários (Contexto de Conversa)

**Atividade 3.1: Implementar um mecanismo para manter o contexto da conversa por usuário, garantindo que o Gemini não misture os contextos.**

*   **Descrição:** O WhatsApp enviará várias mensagens simultâneas de usuários diferentes. O Gemini precisa gerenciar instâncias de conversa separadas para cada usuário para manter a coerência e o contexto. Isso geralmente é feito armazenando o histórico da conversa por `chatId` (ou `from_number`).
*   **Abordagem Sugerida:**
    1.  **Armazenamento do Histórico por Usuário:** Utilizar um banco de dados (como o Supabase, que já está em uso) para armazenar o histórico de mensagens de cada `chatId`. Cada entrada deve incluir o `chat_id`, `timestamp`, `author` (user/model) e `message_content`.
    2.  **Recuperação do Histórico:** Antes de chamar o Gemini para uma nova mensagem, recuperar o histórico recente da conversa para o `chatId` específico.
    3.  **Passar Histórico para o Gemini:** O histórico relevante da conversa do usuário atual deve ser incluído no `contexto` ou como parte da `mensagem_usuario` (se a API do Gemini suportar histórico de mensagens diretamente no payload). Para evitar a mistura de contextos, **nunca** compartilhar o histórico de um usuário com a chamada do Gemini para outro usuário.
    4.  **Atualização do Histórico:** Após cada interação (mensagem do usuário e resposta do Gemini), a nova mensagem e a resposta devem ser adicionadas ao histórico do `chatId` correspondente.
*   **Considerações:**
    *   **Supabase:** Criar uma tabela `conversation_history` com colunas como `chat_id` (chave primária ou índice), `timestamp`, `author` (user/model), `message_content`.
    *   **Limitação de Contexto:** O Gemini tem um limite de tokens para o contexto. Implementar uma estratégia para resumir ou truncar o histórico da conversa se ele exceder esse limite (ex: manter apenas as últimas N interações ou resumir interações antigas).
    *   **Segurança:** Garantir que o histórico de conversas seja armazenado e acessado de forma segura, com políticas de acesso baseadas no `chat_id`.
    *   **Concorrência:** Se houver múltiplas mensagens do mesmo usuário chegando quase simultaneamente, garantir que o acesso e a atualização do histórico sejam thread-safe (se o ambiente Python for multi-threaded) ou que a lógica de n8n gerencie a fila de mensagens por usuário.

### 4. Validação e Feedback para Intenções Não Suportadas

**Atividade 4.1: Refinar a resposta do Gemini para perguntas fora do escopo.**

*   **Descrição:** Se o Gemini receber uma pergunta que não se alinha com os objetivos definidos, ele deve ser instruído a responder de forma a redirecionar o usuário para as funcionalidades suportadas, em vez de tentar responder à pergunta diretamente ou dar uma resposta genérica.
*   **Local de Alteração:** Já abordado na Atividade 1.1, através do refinamento do `contexto` do Gemini.

### 5. Testes Adicionais

**Atividade 5.1: Criar um novo caso de teste para a primeira interação do usuário.**

*   **Descrição:** Adicionar um teste específico que simule a primeira pergunta do usuário ("Eu posso fazer reserva?") e verifique se a resposta do sistema (via Gemini) é coerente com os objetivos do sistema de reservas.
*   **Local de Alteração:** Arquivo de teste existente ou novo arquivo em `C:\source\IAResipa\tests\06.interpretartexto\`.
*   **Exemplo de Asserção:** Verificar se a mensagem contém palavras-chave como "reservas", "disponibilidade", "Pix", etc., e se o tom é amigável e formal.

### 6. Monitoramento e Ajustes Contínuos

**Atividade 6.1: Monitorar as interações do Gemini em produção e ajustar o contexto conforme necessário.**

*   **Descrição:** A coerência do Gemini é um processo contínuo. É crucial monitorar as respostas em um ambiente real e ajustar o `contexto` e as instruções para o modelo conforme novas interações e necessidades surgirem.

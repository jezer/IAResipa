## 09. Captura de Padrão de Mensagens do Waha para Geração de Dados de Teste

Esta instrução detalha o processo para capturar o formato exato das mensagens recebidas do Waha e utilizá-las para gerar dados de teste objetivos e realistas para os testes automatizados.

### Objetivo

Garantir que os testes em `C:\source\IAResipa\tests\06.interpretartexto` utilizem dados de entrada que reflitam fielmente o formato e a estrutura das mensagens enviadas pelo Waha, aumentando a confiabilidade e a cobertura dos testes.

### Processo de Captura de Mensagens do Waha

1.  **Identificar o Webhook do Waha:**
    *   Localize o endpoint do webhook configurado no Waha que aponta para o seu ambiente de desenvolvimento ou teste. Geralmente, este endpoint é gerenciado pelo `py_waha_receiver_v2.py` (ou `py_waha_receiver.py`).

2.  **Configurar um Listener/Proxy:**
    *   Utilize uma ferramenta como [RequestBin](https://requestbin.com/), [Webhook.site](https://webhook.site/), ou um proxy local (ex: [ngrok](https://ngrok.com/) apontando para um servidor local que loga as requisições) para interceptar as requisições POST enviadas pelo Waha.
    *   **Passos:**
        *   Crie um novo "bin" ou "URL de teste" na ferramenta escolhida.
        *   Atualize temporariamente o webhook do Waha para apontar para esta URL de teste.
        *   Envie mensagens de teste do WhatsApp (via Waha) para o seu número configurado.

3.  **Capturar e Analisar o Payload:**
    *   Observe as requisições recebidas na ferramenta de listener/proxy.
    *   Copie o payload JSON completo da requisição POST. Este é o formato exato da mensagem que o Waha envia.
    *   Analise a estrutura do JSON para entender os campos relevantes (ex: `messages`, `contacts`, `from`, `text`, `type`, `id`, etc.).

### Geração de Material Objetivo para Testes

Com o payload JSON capturado, você pode gerar dados de teste de forma objetiva:

1.  **Criar Arquivos de Dados de Teste (JSON/YAML):**
    *   Na pasta `C:\source\IAResipa\tests\06.interpretartexto\data\` (crie se não existir), crie arquivos JSON ou YAML para armazenar os payloads de exemplo.
    *   Nomeie os arquivos de forma descritiva (ex: `waha_text_message_example.json`, `waha_image_message_example.json`).

    ```json
    // tests/06.interpretartexto/data/waha_text_message_example.json
    {
      "messages": [
        {
          "from": "5511999999999",
          "id": "ABGGJ...",
          "text": {
            "body": "Olá, gostaria de fazer uma reserva."
          },
          "type": "text"
        }
      ],
      "contacts": [
        {
          "profile": {
            "name": "Nome do Usuário"
          },
          "wa_id": "5511999999999"
        }
      ]
    }
    ```

2.  **Integrar Dados nos Testes Pytest:**
    *   Nos seus arquivos de teste em `C:\source\IAResipa\tests\06.interpretartexto`, utilize esses arquivos de dados para simular as mensagens recebidas.
    *   Você pode carregar esses dados usando a biblioteca `json` ou `yaml` do Python.

    ```python
    import pytest
    import json
    import os

    # Exemplo de como carregar o payload de um arquivo
    def load_waha_payload(filename):
        filepath = os.path.join(os.path.dirname(__file__), 'data', filename)
        with open(filepath, 'r', encoding='utf-8') as f:
            return json.load(f)

    class TestWhatsappMessageReception:
        # ... (fixture de setup)

        def test_receive_message_from_registered_user(self, setup_whatsapp_reception):
            # ...
            waha_payload = load_waha_payload('waha_text_message_example.json')
            # Modificar o payload conforme necessário para o cenário de teste
            waha_payload['messages'][0]['from'] = setup_whatsapp_reception['registered_user_number']

            # Simular o recebimento da mensagem com o payload real
            # response = process_waha_message(waha_payload)
            # ...
    ```

### Checklist para Geração de Dados de Teste

*   [ ] Webhook do Waha temporariamente redirecionado para um listener/proxy.
*   [ ] Payload JSON de diferentes tipos de mensagens (texto, imagem, áudio, etc.) capturado.
*   [ ] Arquivos de dados de teste criados em `tests/06.interpretartexto/data/` com os payloads capturados.
*   [ ] Testes automatizados atualizados para carregar e utilizar esses dados de teste.
*   [ ] Verificação de que os testes cobrem variações importantes do payload (ex: mensagens com/sem `contacts`, diferentes tipos de `messages`).

```
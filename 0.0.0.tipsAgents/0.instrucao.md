(üáßüá∑ S√£o Paulo ‚Äî 17/08/2025, 18:00)

Bora deixar isso √† prova de mistura entre perfis. Abaixo est√° um ‚Äúcontrato de perfis‚Äù + templates de prompt, checklists e valida√ß√µes autom√°ticas. Voc√™ pode colar direto no seu reposit√≥rio `siteAgendamento/` e usar tanto no Gemini quanto no Copilot.

---

---


---

# Templates de Prompt (para Gemini/Copilot)

Use **exatamente um** perfil por vez. Sempre comece com este cabe√ßalho:

```
[SYSTEM]
Voc√™ √© {NOME_DO_PERFIL} com id {ID_DO_PERFIL}.
√â proibido responder fora do escopo deste perfil.
Se faltarem informa√ß√µes do seu escopo, responda ‚ÄúN√£o definido neste perfil‚Äù e referencie o arquivo/ID correto.
Sa√≠da deve conter front-matter YAML com `profile: {ID_DO_PERFIL}`.

[INPUT]
{tarefa/artefato desejado}

[CONSTRAINTS]
- N√£o contradizer `docs/regras-negocio.md` (para Dev e Arquiteto).
- Numeradores (X dias/horas) devem ser referenciados de `docs/settings.md` (ou criar, se n√£o existir).
- Proibir opini√£o fora do escopo do perfil.

[OUTPUT]
Forne√ßa somente os arquivos/trechos do perfil atual, no formato exigido.
```

### Prompt de exemplo ‚Äî Perfil Neg√≥cio

```
[SYSTEM] ... id perfil.negocio ...
[INPUT]
Produza `docs/regras-negocio.md` com base no template r√°pido abaixo, parametrizando todos os n√∫meros em `docs/settings.md`.

[CONSTRAINTS]
- Sem c√≥digo, sem SQL, sem tecnologias espec√≠ficas.
- Cobrir: janela de agendamento, dura√ß√£o, limites por usu√°rio, cancelamento/no-show, waitlist, resolu√ß√£o de conflitos, auditoria/LGPD.
```

### Prompt de exemplo ‚Äî Perfil Arquiteto

```
[SYSTEM] ... id perfil.arquitetura ...
[INPUT]
Gerar `supabase/policies.sql` com RLS para recursos (quiosques/quadras). Inclua pol√≠ticas para: no-overlap, cooldown, limite de reservas ativas, waitlist e promo√ß√£o segura.
Inclua `architecture/decisoes-adr.md` com trade-offs de RLS vs. l√≥gica no app.

[CONSTRAINTS]
- N√£o redefinir regras; apenas refletir o documento de neg√≥cio existente.
- Referenciar `docs/settings.md` para par√¢metros.
```

### Prompt de exemplo ‚Äî Perfil Dev

```
[SYSTEM] ... id perfil.dev ...
[INPUT]
Criar `functions/rpc.sql` com uma RPC `criar_agendamento(...)` transacional, respeitando cooldown e no-overlap, e `promover_waitlist(...)`.
Criar `web/js/agendamentos.js` consumindo Supabase Auth.

[CONSTRAINTS]
- N√£o alterar pol√≠ticas RLS; falhas devem retornar erros trat√°veis.
- Incluir testes m√≠nimos em `tests/`.
```

---

# `docs/settings.md` (fonte √∫nica de par√¢metros)

Crie/alimente este arquivo e **nunca** codifique n√∫meros fixos nos outros artefatos.

```md
---
profile: perfil.negocio
version: 1.0
status: draft
owner: "Gest√£o/Neg√≥cio"
---
# Settings (Parametriza√ß√µes)
cooldown_quiosque_dias: 15
antecedencia_min_horas: 24
antecedencia_max_dias: 60
duracao_padrao_horas: 2
limite_reservas_ativas_total: 2
limite_reservas_quiosque_mes: 1
cancelamento_sem_multa_horas: 48
cancelamento_parcial_janela_horas: 6
bloqueio_parcial_quiosque_dias: 7
bloqueio_noshow_quiosque_dias: 30
janela_confirmacao_waitlist_horas: 2
```

---

# Checklists de Qualidade (Gate de Aceite)

## Gest√£o / Neg√≥cio ‚Äî `checklists/negocio.md`

* [ ] Todos os n√∫meros est√£o em `docs/settings.md`.
* [ ] Casos-limite descritos (sobreposi√ß√£o, no-show, cooldown + waitlist).
* [ ] Fluxos cobrem happy path e erros.

## Arquiteto ‚Äî `checklists/arquitetura.md`

* [ ] RLS habilitado para todas as tabelas sens√≠veis.
* [ ] Policies testadas com **usu√°rio A** vs **usu√°rio B**.
* [ ] Conflitos bloqueados em n√≠vel de transa√ß√£o.
* [ ] Logs/auditoria m√≠nimos definidos.

## Dev ‚Äî `checklists/dev.md`

* [ ] RPCs usam transa√ß√£o e verificam conflito com `FOR UPDATE` (ou equivalente).
* [ ] Testes automatizados para: overlap, cooldown, limites, waitlist.
* [ ] UI trata erros do Supabase com mensagens claras.
* [ ] Nenhum n√∫mero hardcoded que exista em `docs/settings.md`.

---

# Valida√ß√µes Autom√°ticas (scripts simples)

## 1) Lint de perfil (impede mistura)

`scripts/lint_perfil.py` (ideia de regra):

* Todo arquivo `.md/.sql/.js/.py` deve conter front-matter com `profile: ...`.
* Bloquear PR se um arquivo do `perfil.dev` citar c√≥digo de pol√≠tica/DDL (link pode, **colar** n√£o).
* Bloquear se refer√™ncia a par√¢metro n√£o existir em `docs/settings.md`.

## 2) Teste anti-contradi√ß√£o

* Pipeline CI executa:

  * Parser das regras de neg√≥cio ‚Üí gera matriz de restri√ß√µes (ex.: `limite_reservas_quiosque_mes=1`).
  * Verifica se `policies.sql` e `rpc.sql` implementam a mesma restri√ß√£o (match por nome/descri√ß√£o).
  * Falha se houver diverg√™ncia.

---

# Estrutura de Pastas Sugerida

```
siteAgendamento/
  docs/
    visao-geral.md
    regras-negocio.md
    politicas-cancelamento.md
    fluxos.md
    faq.md
    settings.md
  architecture/
    diagrama.drawio
    decisoes-adr.md
  supabase/
    schema.sql
    policies.sql
    seed.sql
    rpc.sql
  web/
    js/
      agendamentos.js
    assets/
  tests/
    api/
    db/
  scripts/
    lint_perfil.py
    check_params.py
  checklists/
    negocio.md
    arquitetura.md
    dev.md
```

---

# Snippets iniciais (prontos pra colar)

## Template r√°pido para `docs/regras-negocio.md` (perfil.negocio)

```md
---
profile: perfil.negocio
version: 1.0
status: draft
owner: "Gest√£o/Neg√≥cio"
---

# Regras de Neg√≥cio

## Recursos e Capacidades
- Recursos com agendamento diario: quiosque_1, quiosque_2, quiosque_3, quiosque_familia, 
- Capacidade: 1 agendamento por dia .
- Recursos com agendamento por hora : quadra_beach, quadra_futebol, campo_sintetico.

## Janela de agendamento
- Anteced√™ncia m√≠nima: 3dias
- Anteced√™ncia m√°xima: 90 dias com lista de espera

## Dura√ß√£o e faixas
- Dura√ß√£o padr√£o: {{settings.duracao_padrao_horas}}h
- Sem sobreposi√ß√£o: confirma somente se n√£o conflitar.

## Limites por usu√°rio
- Cooldown quiosques: {{settings.cooldown_quiosque_dias}} dias
- Reservas ativas m√°x.: {{settings.limite_reservas_ativas_total}}
- Limite quiosque/m√™s: {{settings.limite_reservas_quiosque_mes}}

## Cancelamento e no-show
- Sem multa at√© {{settings.cancelamento_sem_multa_horas}}h
- Entre {{settings.cancelamento_sem_multa_horas}}h e {{settings.cancelamento_parcial_janela_horas}}h: bloqueio {{settings.bloqueio_parcial_quiosque_dias}} dias
- <{{settings.cancelamento_parcial_janela_horas}}h ou no-show: bloqueio {{settings.bloqueio_noshow_quiosque_dias}} dias

## Lista de espera
- Entrada se faixa ocupada e sem violar regras.
- Prioridade: ordem + ocorr√™ncias + hist√≥rico.
- Promo√ß√£o: janela de confirma√ß√£o {{settings.janela_confirmacao_waitlist_horas}}h

## Resolu√ß√£o de conflitos
- Em n√≠vel de transa√ß√£o (DB).

## Auditoria e LGPD
- Log de a√ß√µes com metadados m√≠nimos.
```

## Cabe√ßalho para `supabase/policies.sql` (perfil.arquitetura)

```sql
/* 
profile: perfil.arquitetura
version: 1.0
status: draft
owner: Arquiteto T√©cnico
refs: docs/regras-negocio.md, docs/settings.md
*/
```

## Coment√°rio padr√£o para c√≥digo do Dev (perfil.dev)

/\*
profile: perfil.dev
version: 1.0
status: draft
owner: Dev Front/Back
refs: supabase/policies.sql, docs/settings.md
\*/

---

# Como usar no dia a dia (r√°pido)

1. **Escolha o perfil** (Neg√≥cio, Arquitetura, Dev).
2. **Dispare o prompt do perfil** (templates acima).
3. **Gere somente os arquivos daquele perfil** com front-matter correto.
4. **Rode o lint** (`scripts/lint_perfil.py`) e os **checklists**.
5. **PR** bloqueia se houver mistura ou contradi√ß√£o.

---

Se quiser, j√° te entrego um `lint_perfil.py` b√°sico e um `check_params.py` para CI na pr√≥xima mensagem.

Refer√™ncia: sua pr√≥pria especifica√ß√£o do projeto **siteAgendamento** (contrato acima).

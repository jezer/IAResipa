

## üìú Instru√ß√µes T√©cnicas ‚Äî Agente Coordenador

### **1. Papel e Escopo**

Voc√™ √© um **Agente Coordenador** que:

* Recebe toda entrada do usu√°rio.
* Identifica qual **agente especializado** deve responder.
* Recupera e atualiza **contexto** no **Supabase**.
* Encaminha a solicita√ß√£o ao **endpoint do agente** (Azure Function ou API Python).
* Recebe, valida e entrega a resposta ao usu√°rio.
* Gerencia **handoff** quando um agente n√£o souber responder.

---

### **2. Cat√°logo de Agentes**

**Formato de cadastro no Supabase** (`agents` table):

```sql
create table agents (
    name text primary key,
    description text,
    capabilities jsonb,
    triggers text[],
    endpoint text,
    schema_in jsonb,
    schema_out jsonb,
    enabled boolean default true,
    confidence_boost float default 0.0
);
```

**Exemplo:**

```json
{
  "name": "AgentePedido",
  "description": "Cria e edita pedidos",
  "capabilities": ["criar_pedido", "editar_pedido"],
  "triggers": ["comprar", "fazer pedido", "adicionar item"],
  "endpoint": "https://.../pedido",
  "schema_in": {"produto":"string","qtd":"int","cliente_id":"string?"},
  "schema_out": {"pedido_id":"string","status":"string","msg":"string"},
  "enabled": true
}
```

---

### **3. Fluxo de Decis√£o**

1. **Receber entrada do usu√°rio**.
2. **Classificar inten√ß√£o** (match por `triggers` + verifica√ß√£o sem√¢ntica com Gemini).
3. **Checar contexto no Supabase** (`state` table):

```sql
create table state (
    user_id text primary key,
    last_pedido_id text,
    extras jsonb
);
```

4. **Escolher agente**:

   * Se `confidence >= 0.6` ‚Üí encaminhar.
   * Sen√£o ‚Üí pedir esclarecimento ou acionar **AgenteSuporte**.
5. **Montar chamada** com `params` completos (merge: input + contexto).
6. **Chamar endpoint** (Azure Function ou API Python).
7. **Atualizar Supabase** (`interactions` table) com request/response:

```sql
create table interactions (
    id bigserial primary key,
    ts timestamptz default now(),
    user_id text,
    turn int,
    agent text,
    role text,
    payload jsonb,
    result jsonb
);
```

8. **Retornar resposta** ao usu√°rio ou encadear pr√≥xima a√ß√£o.

---

### **4. Adi√ß√£o de Novo Agente**

1. Criar endpoint (Azure Function ou FastAPI).
2. Definir `schema_in` / `schema_out`.
3. Inserir no `agents` do Supabase.
4. Adicionar exemplos no prompt do coordenador.
5. Testar roteamento com intents reais.
6. Ativar (`enabled=true`).

---

### **5. Protocolo de HANDOFF**

Quando um agente n√£o puder atender:

```json
{
  "type": "handoff",
  "from_agent": "AgenteSuporte",
  "reason": "capacidade n√£o suportada",
  "needed_capability": "cotacao_internacional",
  "suggested_params": {"moeda": "BRA"},
  "confidence": 0.35
}
```

**No coordenador:**

* Procurar agente com `capabilities` compat√≠vel.
* Se existir ‚Üí reencaminhar.
* Se n√£o existir ‚Üí perguntar ao usu√°rio.
* Evitar loops (m√°x. 2 tentativas por mesmo motivo).

---

### **6. Integra√ß√£o T√©cnica**

* **Azure Functions** ‚Üí cada agente como fun√ß√£o independente (`/api/agente_nome`).
* **Endpoints Python** ‚Üí FastAPI com rotas separadas por agente.
* **Supabase** ‚Üí contexto, cat√°logo de agentes, hist√≥rico.
* **Gemini API**:

  * Coordenador com **function calling** para acionar agentes.
  * Few-shot no prompt com exemplos de roteamento.

---

### **7. Prompt Base do Coordenador**

```markdown
Voc√™ √© um Agente Coordenador.
Regras:
1. Leia a entrada do usu√°rio e determine a inten√ß√£o.
2. Consulte o cat√°logo `agents` (Supabase) para achar o agente mais adequado.
3. Se precisar, recupere contexto (`state`) para preencher par√¢metros.
4. Responda apenas com JSON:
   {
     "route_to": "<agent_name>",
     "confidence": <float>,
     "params": { ... },
     "reason": "<why>"
   }
5. Se n√£o houver agente compat√≠vel, acione AgenteSuporte ou solicite esclarecimento.
6. Se receber um HANDOFF, siga o protocolo e reencaminhe.
7. Sempre registre `payload` e `result` em `interactions`.
```

# 1. Instalação das Bibliotecas Python no Ambiente Docker do n8n

Este documento descreve os passos para garantir que a biblioteca Python `resipaia` e suas dependências sejam instaladas corretamente dentro do contêiner Docker do n8n. Isso permitirá que os scripts Python chamados pelo n8n (`py_main_processor.py` e outros) possam importar e utilizar a `resipaia` como um pacote Python instalado.

## 1.1. Pré-requisitos

Para garantir uma instalação bem-sucedida, siga os pré-requisitos abaixo:

*   [x] **1.1.1. Compilação da Biblioteca:** Execute o script `01.commands/compile_resipaia_library_v2.ps1` na raiz do seu projeto. Este passo é **obrigatório** e deve ser feito **antes** de construir a imagem Docker. Ele irá:
    *   [x] Gerar o arquivo `.whl` da biblioteca `resipaia` no diretório `dist/`.

items[0].json["session"]
item[0].json

[
  {
    "message": {
      "session": "default",
      "PushName": "Jezer Portilho",
      "Chat": "5511964703712@s.whatsapp.net",
      "id": "false_5511964703712@c.us_3F5DEEB366F1178BDE50",
      "event": "message",
      "fromMe": false,
      "text": "ajuda",
      "body": "ajuda",
      "from": "5511964703712@c.us"
    }
  }
]
e a forma de ler esse json é: 
item[0].json["PushName"]
item[0].json["Chat"]
item[0].json["id"]
item[0].json["event"]
item[0].json["fromMe"]
item[0].json["text"]
item[0].json["body"]
item[0].json["from"]

*   [ ] **1.1.2. Acessibilidade do Diretório `dist/`:** Certifique-se de que o diretório `dist/` (contendo o `.whl` gerado) esteja acessível no contexto de build do Docker. Isso geralmente significa que ele deve estar no mesmo diretório do seu `Dockerfile` ou em um subdiretório que será copiado.
    *   [ ] **1.1.2.1. Copiar `.whl` para Contêiner em Execução (Apenas para Teste/Depuração):** Se você precisar copiar o arquivo `.whl` para um contêiner Docker já em execução (por exemplo, para testes rápidos sem reconstruir a imagem), utilize o comando `docker cp`:
        ```bash
        docker cp "C:/source/IAResipa/dist/resipaia_1.0.0_2025_07_06_22_51.whl" 13f2c48344ea:/usr/local/
        docker exec -it iawaha-n8n-1 sh
        sudo pip install /usr/local/resipaia_1.0.0_2025_07_06_22_51.whl


        docker cp dist/resipaia-*.whl 13f2c48344ea:/usr/local/ 
        ```
        Substitua `<nome_do_seu_container_n8n>` pelo nome ou ID do seu contêiner n8n em execução. O caminho `/usr/src/app/` é o `WORKDIR` definido no `Dockerfile` de exemplo, mas ajuste se o seu `WORKDIR` for diferente.

CONTAINER ID   IMAGE                     COMMAND                  CREATED       STATUS       PORTS                    NAMES
13f2c48344ea   n8nio/n8n:latest          "tini -- /docker-ent…"   4 weeks ago   Up 3 hours   0.0.0.0:5678->5678/tcp   iawaha-n8n-1

FROM n8nio/n8n:latest

# Instalar Python e pip
RUN apt update && apt install -y python3 python3-pip

# Copiar o arquivo .whl para o container
COPY C:/source/IAResipa/dist/resipaia_*.whl /usr/local/

# Instalar a biblioteca
RUN pip3 install /usr/local/resipaia_*.whl


docker build -t n8n-python .
docker run -d --name n8n-python-container n8n-python

backup total
DRIVER    VOLUME NAME
local     iawaha_n8n_data
local     iawaha_pgdata
local     iawaha_waha_media
local     iawaha_waha_sessions

docker run --rm -v iawaha_n8n_data:/volume -v C:/source/IAResipa/04.deploy/docker/backup_atual:/backup alpine tar -czf /backup/iawaha_n8n_data.tar.gz -C /volume ./
docker run --rm -v iawaha_pgdata:/volume -v C:/source/IAResipa/04.deploy/docker/backup_atual:/backup alpine tar -czf /backup/iawaha_pgdata.tar.gz -C /volume ./
docker run --rm -v iawaha_waha_media:/volume -v C:/source/IAResipa/04.deploy/docker/backup_atual:/backup alpine tar -czf /backup/iawaha_waha_media.tar.gz -C /volume ./
docker run --rm -v iawaha_waha_sessions:/volume -v C:/source/IAResipa/04.deploy/docker/backup_atual:/backup alpine tar -czf /backup/iawaha_waha_sessions.tar.gz -C /volume ./

REPOSITORY         TAG       IMAGE ID       CREATED          SIZE
n8nio/n8n          latest    509c9138e88a   4 weeks ago      1.41GB
devlikeapro/waha   latest    c13eea0f5582   5 weeks ago      3.88GB

meu-n8n-python     latest    81b21a23f345   35 minutes ago   1.47GB
backup-n8n         latest    2d5ecab78139   3 weeks ago      1.47GB
backup-waha        latest    420c3dc892e0   3 weeks ago      3.88GB
backup-redis       latest    63fffd9d2372   3 weeks ago      188MB
backup-iawaha      latest    b176c3f892a9   3 weeks ago      3.88GB
mongo              latest    98028cf281bb   4 weeks ago      1.2GB
alpine             latest    8a1f59ffb675   5 weeks ago      12.8MB
redis              latest    dbf3e4b6ad3e   5 weeks ago      188MB
postgres           latest    6efd0df010dc   6 weeks ago      621MB

docker save -o C:/source/IAResipa/04.deploy/docker/backup_atual/backup_n8n.tar n8nio/n8n:latest
docker save -o C:/source/IAResipa/04.deploy/docker/backup_atual/backup_waha.tar devlikeapro/waha:latest

docker commit <nome_do_container> backup_<nome_do_container>
docker save -o C:/backup/backup_<nome_do_container>.tar backup_<nome_do_container>


docker-compose down

docker-compose -f "C:\source\IAResipa\04.deploy\docker\docker-compose.yml" up



*   [ ] **1.1.3. Script de Instalação:** O script `docker_install_script.sh` (localizado em `tests/exemplo/docker_install_script.sh`) deve ser copiado para um local acessível dentro do contexto de build do Docker. Ele será usado para instalar o `.whl` dentro do contêiner.


excluir imagens:
meu-n8n-python     latest    81b21a23f345   35 minutes ago   1.47GB
backup-n8n         latest    2d5ecab78139   3 weeks ago      1.47GB
backup-waha        latest    420c3dc892e0   3 weeks ago      3.88GB
backup-redis       latest    63fffd9d2372   3 weeks ago      188MB
backup-iawaha      latest    b176c3f892a9   3 weeks ago      3.88GB
mongo              latest    98028cf281bb   4 weeks ago      1.2GB
alpine             latest    8a1f59ffb675   5 weeks ago      12.8MB
redis              latest    dbf3e4b6ad3e   5 weeks ago      188MB
postgres           latest    6efd0df010dc   6 weeks ago      621MB


docker rmi 
docker rmi 6efd0df010dc
## 1.2. Processo de Instalação

Para instalar a biblioteca `resipaia` e suas dependências no contêiner n8n, você precisará modificar o `Dockerfile` do seu contêiner. Siga os passos detalhados abaixo:

### 1.2.1. Exemplo de `Dockerfile`

Considere o seguinte snippet para o seu `Dockerfile` do n8n. Este exemplo assume que o `Dockerfile` está na raiz do seu projeto e que o script `docker_install_script.sh` está em `tests/exemplo/`.

```dockerfile
# Use a imagem oficial do n8n como base
FROM n8n/n8n

# Define o diretório de trabalho dentro do contêiner
WORKDIR /usr/src/app

# Copia o arquivo .whl da biblioteca resipaia do diretório dist/ para o contêiner
# Certifique-se de que o script compile_resipaia_library_v2.ps1 foi executado previamente
COPY dist/resipaia-*.whl .

# Copia o script de instalação
COPY tests/exemplo/docker_install_script.sh .

# Garante que o script seja executável
RUN chmod +x tests/exemplo/docker_install_script.sh

# Executa o script de instalação da biblioteca
RUN tests/exemplo/docker_install_script.sh

# Opcional: Se você tiver um requirements.txt na raiz do seu projeto
# para dependências que não são da sua biblioteca, instale-as aqui.
# RUN pip install -r requirements.txt

# Expor a porta do n8n (se não estiver já exposta na imagem base)
# EXPOSE 5678

# Comando padrão para iniciar o n8n
CMD [ "n8n" ]
```

### 1.2.2. Explicação Detalhada dos Passos no `Dockerfile`

*   [ ] **1.2.2.1. `FROM n8n/n8n`**: Inicia a construção da imagem a partir da imagem oficial do n8n.

*   [ ] **1.2.2.2. `WORKDIR /usr/src/app`**: Define o diretório de trabalho padrão dentro do contêiner. É uma boa prática para organizar seus arquivos.

*   [ ] **1.2.2.3. `COPY dist/resipaia-*.whl .`**: Copia o arquivo `.whl` gerado pela compilação prévia (Passo 1.1.1) do diretório `dist/` do seu host para o diretório de trabalho (`/usr/src/app`) dentro do contêiner. O curinga `resipaia-*.whl` garante que o nome exato do arquivo (que inclui a versão) seja capturado.

*   [ ] **1.2.2.4. `COPY tests/exemplo/docker_install_script.sh .`**: Copia o script de instalação (`docker_install_script.sh`) do seu projeto (localizado em `tests/exemplo/`) para o diretório de trabalho (`/usr/src/app`) dentro do contêiner. Isso o torna acessível para execução.

*   [ ] **1.2.2.5. `RUN chmod +x docker_install_script.sh`**: Torna o script de instalação executável dentro do contêiner.

*   [ ] **1.2.2.6. `RUN ./docker_install_script.sh`**: Executa o script `docker_install_script.sh` dentro do contêiner. Este script, por sua vez, irá:
    *   [ ] Encontrar o arquivo `.whl` que foi copiado para o contêiner.
    *   [ ] Instalar o `.whl` usando `pip install`.

*   [ ] **1.2.2.7. `CMD [ "n8n" ]`**: Comando padrão para iniciar o n8n quando o contêiner é executado.

## 1.3. Verificação da Instalação

Após a construção e execução do contêiner Docker, a biblioteca `resipaia` estará instalada e seus módulos poderão ser importados diretamente nos scripts Python chamados pelo n8n (por exemplo, `from resipaia.py_main_processor import main`).

*   [ ] **1.3.1. Teste de Importação:** Para verificar a instalação, você pode acessar o shell do contêiner Docker em execução e tentar importar a biblioteca:
    ```bash
    docker exec -it <nome_do_seu_container_n8n> bash
    python -c "import resipaia; print('resipaia importado com sucesso!')"
    ```
    Se a importação for bem-sucedida, a mensagem será exibida. Caso contrário, um erro de `ModuleNotFoundError` será retornado.

Isso garante que o n8n possa executar seus scripts Python sem problemas de importação, pois a biblioteca estará disponível no ambiente Python do contêiner.
